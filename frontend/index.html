<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<title>Semantic and Interactive Navigation In Videos</title>
</head>
<body style="width:100vw; height:100vh; ">
<div class="container" style="width: 100%; height: 100%; margin: auto; ">
    <div class="row" style="width: 100%; height: 100%;">
        <div class="col-sm" style="overflow-x: hidden; overflow-y: auto; width:50%; height:100%;"> <!-- inputs (video, crop, query) -->
            <div style="width:100%;" class="row">
                <label style="width:15%">Video: </label>
                <select id="video_names_selection" style="width:84%" name="video_names"></select>
            </div>
            <canvas class="row" style="min-width:80; max-width:100%; max-height:75%; margin:auto;" id="video"></canvas>
            <!--tabindex makes the element focusable-->
            <canvas class="row" tabindex="0" style="width:100%; height:15%; border:1px solid lightgray; margin:auto;" id="timeline"></canvas> 
            <div class="row">
                <input type="button" id="new_selection" style="margin:0.1%;" value="new" class="col btn btn-sm btn-primary"/>
                <select class="col" id="selections" name="selections">
                    <option style="color:royalblue;">blue</option>
                </select>
                <input type="button" id="set_operator" style="margin:0.1%;" value="perform" class="col btn btn-sm btn-primary"/>
                <select class="col" id="operator_list" name="operator_list">
                    <option value="intersection">AND</option>
                    <option value="union">OR</option>
                    <option value="xor">OR (exclusive) </option>
                    <option value="difference">MINUS (difference)</option>
                </select>
                <select class="col" id="selections2" name="selections2"></select>
            </div>
            <div class="row">
                <label class="col text-left" id="crop_label">Cropped area: </label>
            </div>
            <div class="row justify-content-center">
                <canvas class="text-center" id="crop"></canvas>
            </div>
        </div>
        <div class="col-sm" style="overflow-x: hidden; overflow-y: auto; width:50%; height:100%; "> <!-- outputs (window.scores, tsne reduction, detected objects) -->
            <label class="row">Inputs:</label>
            <input type="text" id="query_input" class="row form-control"/>
            <div class="row">
                <input type="button" id="text_search_button" style="margin:0.1%;" value="Text-based search" class="btn btn-sm btn-primary"/>
                <input type="button" id="object_detection_button" style="margin:0.1%;" value="Object detection" class="btn btn-sm btn-secondary" />
                <input type="button" id="depthmap_computation_button" style="margin:0.1%;" value="Depth estimation" class="btn btn-sm btn-secondary" />
            </div>
            <div class="row">
                <input type="button" id="image_search_button" style="margin:0.1%;" value="Crop-image-based search" class="btn btn-sm btn-primary"/>
                <input type="button" id="toggle_crop" style="margin:0.1%;" value="toggle cropping" class="btn btn-sm btn-secondary" />
            </div>
            <label class="row">Outputs:</label>
            <input type="button" id="toggle_obj" style="width:100%;" value="▲ Detected objects" class="row btn btn-sm btn-info"/>
            <div class="row" id="obj_div">
                <canvas id="obj_plot" style="display:block; width:100%;"></canvas>
            </div>
            <input type="button" id="toggle_scores" style="width:100%;" value="▲ Similarity scores chart" class="row btn btn-sm btn-info"/>
            <div class="row justify-content-center" style="width:100%;" id="score_div">
                <canvas id="score_plot" style="display:block; width:100%;"></canvas>
                <div class="row">
                    <input type="button" id="select_threshold" value="select threshold" style="margin:0.1%;" class="col-sm btn btn-sm btn-secondary"/>
                    <input type="button" id="reset_score_plot" value="reset" style="margin:0.1%;" class="col-sm btn btn-sm btn-secondary"/>
                </div>
            </div>  
            <input type="button" id="toggle_reduction" style="width:100%;" value="▲ Video embeddings scatter plot in reduced embedding space" class="row btn btn-sm btn-info"/>
            <div class="row" id="tsne_div" width="100%">
                <div class="row">
                    <div class="col-sm justify-content-center">
                        <input type="radio" name="select_reduction_method" value="tsne" checked />
                        <label>t-sne</label>
                    </div>
                    <div class="col-sm justify-content-center">
                        <input type="radio" name="select_reduction_method" value="pca"/>
                        <label>pca</label>
                    </div>
                    <div class="col-sm justify-content-center">
                        <input type="radio" name="select_reduction_method" value="umap"/>
                        <label>umap</label>
                    </div>
                </div>
                <canvas class="row" id="reduction_plot" style="display:block; width:100%;" ></canvas>
                <div class="row justify-content-center">
                    <canvas class="text-center" id="tsne_color_map" height="0px"></canvas>
                </div>
                <div class="row">
                    <div class="col-sm justify-content-center">
                        <input type="radio" name="select_color_map" value="default" checked />
                        <label>default</label>
                    </div>
                    <div class="col-sm justify-content-center">
                        <input type="radio" name="select_color_map" value="clusters"/>
                        <label>dbscan</label>
                    </div>
                    <div class="col-sm justify-content-center">
                        <input type="radio" name="select_color_map" value="time"/>
                        <label>time</label>
                    </div>
                    <div class="col-sm justify-content-center">
                        <input type="radio" name="select_color_map" value="score"/>
                        <label>score</label>
                    </div>
                </div>
                <div class="row">
                    <input type="button" id="select_dots" value="navigate/select" style="margin:0.1%;" class="col-sm btn btn-sm btn-secondary"/>
                    <input type="button" id="reset_reduction_plot" value="reset" style="margin:0.1%;" class="col-sm btn btn-sm btn-secondary"/>
                </div>
            </div>
            <input type="button" id="toggle_depth" style="width:100%;" value="▲ Depth map" class="row btn btn-sm btn-info"/>
            <div class="row" id="depth_div">
                <canvas class="row" style="width:100%; " id="depth_video"></canvas>
            </div>
        </div>
    </div>
</div>
<!--global variables script-->
<script type='text/javascript' > 
    //currently used video
    window.current_video = "";

    //displayed frame
    window.current_index = 0;
    window.current_frame = new Image();
    window.max_index = 100;
    window.fps = 60;
    window.cmap = "default";

    //chart colors/sizes
    window.REGULAR_COLOR = "gray";
    window.EMPHASIS_COLOR = "red";
    window.REGULAR_RADIUS = 2.5;
    window.EMPHASIS_RADIUS = 5;

    //zoom stuff
    window.MIN_SCALE = 0.1;
    window.MAX_SCALE = 100;

    //cropping stuff
    window.crop_top_left = { x: 10, y: 10 };
    window.crop_bot_right = { x: 60, y: 60 };
    window.is_crop_visible = false;

    //selection stuff
    window.selection_top_left = { x: 10, y: 10 };
    window.selection_bot_right = { x: 40, y: 40 };
    window.is_selection = false;
    window.selected_points = [[]];
    window.current_selection = 0;
    const SELECTION_COLORS = [ 
        {red: 65, green: 105, blue: 255}, 
        {red: 178, green: 34, blue: 34}, 
        {red: 225, green: 185, blue: 65}, 
        {red: 34, green: 139, blue: 34}
    ];

    //query result slot
    window.scores = null;
    window.objs = null;
    window.depth = false;

    //dimension reduction stuff
    window.old_reduction = "tsne";
    window.displayed_reduction = null;
    window.tsne_reduction = null;
    window.pca_reduction = null;
    window.umap_reduction = null;
    window.tsne_clusters = null;
    window.pca_clusters = null;
    window.umap_clusters = null;
</script>
<!--main script-->
<script>
    /*variables declaration*/
    //document components
    let text_search_button = document.getElementById("text_search_button");
    let image_search_buttonmage = document.getElementById("image_search_button");
    let object_detection_button = document.getElementById("object_detection_button");
    let depthEstimate = document.getElementById("depthmap_computation_button");

    let toggle_obj = document.getElementById("toggle_obj");
    let toggle_scores = document.getElementById("toggle_scores");
    let toggle_reduction = document.getElementById("toggle_reduction");
    let toggle_depth = document.getElementById("toggle_depth");
    let toggle_crop = document.getElementById("toggle_crop");

    //hiding canvas and buttons at first
    document.getElementById("obj_div").style.display = "none";
    document.getElementById("score_div").style.display = "none";
    document.getElementById("tsne_div").style.display = "none";
    document.getElementById("depth_div").style.display = "none";
    document.getElementById("crop").style.display = "none";
    document.getElementById("crop_label").style.display = "none";
    toggle_obj.style.display = "none";
    toggle_scores.style.display = "none";
    toggle_reduction.style.display = "none";
    toggle_depth.style.display = "none";

    const server_url = 'http://localhost:8000';

    /*methods declaration*/
    let fill_circle = (ctx, point, radius) => {
        ctx.beginPath();
        ctx.ellipse(point.x, point.y, radius, radius, 0, 0, 2 * Math.PI);
        ctx.fill();
    }

    //Plot the vertical line that indicates the current frame on the curve
    let plot_marker = (current_index, max, offset_left, offset_right, offset_y, color, line_width, svg) => {
        let plot_width = svg.width;
        let plot_height = svg.height;
        let ctx = svg.getContext("2d");
        let x = offset_left + (current_index / (max - 1)) * (plot_width - offset_left - offset_right);
        
        ctx.beginPath();
        ctx.moveTo(x, offset_y);
        ctx.lineTo(x, plot_height - offset_y);
        ctx.strokeStyle = color;
        ctx.lineWidth = line_width;
        ctx.stroke();
    };

    let plot_axes = (offset_left, offset_right, offset_y, svg) => {
        let lenX = svg.width;
        let lenY = svg.height;
        let ctx = svg.getContext("2d");

        //draw x axis
        ctx.beginPath();
        ctx.moveTo(offset_left, lenY - offset_y);
        ctx.lineTo(lenX - offset_right, lenY - offset_y);
        ctx.strokeStyle = "black";
        ctx.lineWidth = 1;
        ctx.stroke();

        //draw arrow at the end of the x axis
        ctx.beginPath();
        ctx.moveTo(lenX - offset_right, lenY - offset_y);
        ctx.lineTo(lenX - offset_right - 5, lenY - offset_y + 5);
        ctx.lineTo(lenX - offset_right - 5, lenY - offset_y - 5);
        ctx.closePath();
        ctx.fillStyle = "black";
        ctx.fill();

        //draw y axis
        ctx.beginPath();
        ctx.moveTo(offset_left, offset_y);
        ctx.lineTo(offset_left, lenY - offset_y);
        ctx.strokeStyle = "black";
        ctx.lineWidth = 1;
        ctx.stroke();

        //draw arrow at the end of the y axis
        ctx.beginPath();
        ctx.moveTo(offset_left, offset_y);
        ctx.lineTo(offset_left + 5, offset_y + 5);
        ctx.lineTo(offset_left - 5, offset_y + 5);
        ctx.closePath();
        ctx.fillStyle = "black";
        ctx.fill();
        ctx.stroke();
    };

    //update video component
    let update_video = (image_url) => {
        // Set the image source to the created URL
        window.current_frame.src = image_url;

        // Wait for the image to load
        window.current_frame.onload = () => {
            // Access the width and height properties
            const width = window.current_frame.width;
            const height = window.current_frame.height;

            // Get the canvas element
            const canvas = document.getElementById("video");
            const ctx = canvas.getContext("2d");

            // Set canvas dimensions to match the image
            canvas.width = width;
            canvas.height = height;

            // Clear any previous content on the canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw the image onto the canvas
            ctx.drawImage(window.current_frame, 0, 0, width, height);

            if (window.is_crop_visible) { draw_cropped(); }
        };
    }

    // Update score curve and vertical line position
    let update_scores = (frame_index) => {
        if (window.current_index != frame_index) { window.current_index = frame_index; }
        // Update plot
        plot_timeline(frame_index, window.max_index, window.fps);
        plot_objects(frame_index);
        plot_score_curve(frame_index);
        plot_tsne_reduction(frame_index);
        update_depth_video(frame_index);
        //TODO update other plots or frames later (possible in here)
    };

    /*Listeners*/
    //resize listener has to addapt the sizes of each component that has height as a function of width
    window.addEventListener("resize", () => {
        //update components' relative sizes
        let score_plot = document.getElementById("score_plot");
        score_plot.width = score_plot.offsetWidth;
        score_plot.height = score_plot.width * 0.5;

        let tsne_plot = document.getElementById("reduction_plot");
        tsne_plot.width = tsne_plot.offsetWidth;
        tsne_plot.height = tsne_plot.width;

        let obj_plot = document.getElementById("obj_plot");
        obj_plot.width = obj_plot.offsetWidth;
        obj_plot.height = obj_plot.width * 0.7;

        let timeline = document.getElementById("timeline");
        timeline.width = timeline.offsetWidth;
        timeline.height = timeline.offsetHeight;

        //redraw everything
        update_video(window.current_frame.src);
        update_scores(window.current_index);
    });

    let update_frame_index_onclick = async (svg, offset_left, offset_right, offset_y, nb_values, event) => {
        const mouseX = event.offsetX;
        const mouseY = event.offset_y;

        let plot_width = svg.width;
        let plot_height = svg.height;

        //case clicked on the offset
        if (offset_y > mouseY || mouseY > plot_height - offset_y) { return; }
        if (offset_left > mouseX || mouseX > plot_width - offset_right) { return; }

        let frame_index = Math.trunc((mouseX - offset_left) / (plot_width - offset_right - offset_left) * (nb_values - 1));

        //fetch current frame
        let name_processed = window.current_video.split(".")[0]; 
        const response = await fetch(`${server_url}/image/${name_processed}/${frame_index}.png`);
        const blob = await response.blob();
        const image_url = URL.createObjectURL(blob);

        window.current_frame.src = image_url;
        update_video(window.current_frame.src);
        update_scores(frame_index);
    }

    toggle_crop.addEventListener("click", () => {
        let crop = document.getElementById("crop");
        let crop_label = document.getElementById("crop_label");
        if (window.is_crop_visible == false) {
            window.is_crop_visible = true;
            crop.style.display = "block";
            crop_label.style.display = "block";
            update_video(window.current_frame.src);
        } 
        else {
            window.is_crop_visible = false;
            crop.style.display = "none";
            crop_label.style.display = "none";
            update_video(window.current_frame.src);
        }
    });

    toggle_obj.addEventListener("click", () => {
        let x = document.getElementById("obj_div");
        if (x.style.display === "none") {
            x.style.display = "block";
            toggle_obj.value = "▼ Detected objects";

            let obj_plot = document.getElementById("obj_plot");
            obj_plot.style.display = "block";
            obj_plot.width = obj_plot.offsetWidth;
            obj_plot.height = obj_plot.width * 0.7;

            plot_objects(window.current_index);
        } else {
            x.style.display = "none";
            toggle_obj.value = "▲ Detected objects";
        }
    });

    toggle_scores.addEventListener("click", () => {
        let x = document.getElementById("score_div");
        if (x.style.display === "none") {
            x.style.display = "block";
            toggle_scores.value = "▼ Similarity scores chart";

            let score_plot = document.getElementById("score_plot");
            score_plot.style.display = "block";
            score_plot.width = score_plot.offsetWidth;
            score_plot.height = score_plot.width * 0.5;

            plot_score_curve(window.current_index);
        } else {
            x.style.display = "none";
            toggle_scores.value = "▲ Similarity scores chart";
        }
    });

    toggle_reduction.addEventListener("click", () => {
        let x = document.getElementById("tsne_div");
        if (x.style.display === "none") {
            x.style.display = "block";
            toggle_reduction.value = "▼ Video embeddings scatter plot in reduced embedding space";

            let tsne_plot = document.getElementById("reduction_plot");
            tsne_plot.style.display = "block";
            tsne_plot.width = tsne_plot.offsetWidth;
            tsne_plot.height = tsne_plot.width;

            plot_tsne_reduction(window.current_index);
        } else {
            x.style.display = "none";
            toggle_reduction.value = "▲ Video embeddings scatter plot in reduced embedding space";
        }
    });

    toggle_depth.addEventListener("click", async () => {
        let depth_div = document.getElementById("depth_div");
        if (depth_div.style.display == "none") {
            depth_div.style.display = "block";
            toggle_depth.value = "▼ Depth map";
            
            await update_depth_video(window.current_index);
        } 
        else {
            toggle_depth.value = "▲ Depth map";
            depth_div.style.display = "none";
        }
    });

    //Text-based search, expecting an array of scores plus a reduction array from the server
    text_search_button.addEventListener('click', async () => {
        try {
            let score_plot = document.getElementById("score_plot");

            //query input
            let inputValue = document.getElementById("query_input").value;

            //request similarity scores from the server
            const response = await fetch(`${server_url}/search?query=${inputValue}`);
            const body = await response.json();

            //only keep scores and tsne reduction values
            window.scores = body['scores'].map(function(value,index) { return value[1]; });

            window.tsne_reduction = body['tsne'];
            window.pca_reduction = body['pca'];
            window.umap_reduction = body['umap'];

            window.tsne_clusters = body['tsne_clusters'];
            window.pca_clusters = body['pca_clusters'];
            window.umap_clusters = body['umap_clusters'];
            
            window.displayed_reduction = window.tsne_reduction;

            console.log(body);

            //adjust the max value
            window.max_index = window.scores.length;
            
            let name_processed = window.current_video.split(".")[0]; 
            const imgresponse = await fetch(`${server_url}/image/${name_processed}/${window.current_index}.png`);
            const blob = await imgresponse.blob();
            const image_url = URL.createObjectURL(blob);
            window.current_frame.src = image_url

            //update component
            update_video(window.current_frame.src);

            //show buttons for toggling scores/reduction
            toggle_scores.style.display = "block";
            toggle_reduction.style.display = "block";
            score_plot.addEventListener("click", (event) => update_frame_index_onclick(score_plot, 
                                                            score_plot_offset_left,
                                                            score_plot_offset_right,
                                                            score_plot_offset_y,
                                                            window.max_index,
                                                            event));

            //update the curve plot
            update_scores(window.current_index);
        } 
        catch (error) {
            console.error("Error loading similarity scores: ", error);
        }
    });

    //Image-based search, needs the cropped image to be defined (hover over the 
    //video) and expecting an array of window.scores plus a reduction array from the server
    image_search_button.addEventListener('click', async () => {
        try {
            let score_plot = document.getElementById("score_plot");
            
            const dataURL = cropped.toDataURL('image/png');
            const response = await fetch(`${server_url}/upload_png/`, 
                {method: 'POST', body: JSON.stringify({ image_data: dataURL }), 
                headers: {'Content-Type': 'application/json'}});
            const body = await response.json();

            //only keep window.scores and tsne reduction values
            window.scores = body['scores'].map(function(value,index) { return value[1]; });

            window.tsne_reduction = body['tsne'];
            window.pca_reduction = body['pca'];
            window.umap_reduction = body['umap'];

            window.tsne_clusters = body['tsne_clusters'];
            window.pca_clusters = body['pca_clusters'];
            window.umap_clusters = body['umap_clusters'];

            window.displayed_reduction = window.tsne_reduction;

            console.log(body);
            
            //request to update the image
            let name_processed = window.current_video.split(".")[0]; 
            const imgresponse = await fetch(`${server_url}/image/${name_processed}/${window.current_index}.png`);
            const blob = await imgresponse.blob();
            const image_url = URL.createObjectURL(blob);

            window.current_frame.src = image_url;
            //update component
            update_video(window.current_frame);

            //show buttons for toggling window.scores/reduction
            toggle_scores.style.display = "block";
            toggle_reduction.style.display = "block";
            score_plot.addEventListener("click", (event) => update_frame_index_onclick(score_plot, 
                                                                score_plot_offset_left,
                                                                score_plot_offset_right,
                                                                score_plot_offset_y,
                                                                window.max_index,
                                                                event));

            //update the curve plot
            update_scores(window.current_index);
        }
        catch (error) {
            console.error("Error loading similarity window.scores: ", error);
        }
    });
    
    object_detection_button.addEventListener('click', async () => {
        //when reorganizing the detection's array, it is assumed that the detections are 
        //ordrered in terms of timestamp
        try {
            const response = await fetch(`${server_url}/video/objects/${window.current_video}`);
            const body = await response.json();
            let results = body["result"];

            let classes = [];
            //organizing the final array by timestamp
            let objects = [];
            //objects found in a single timestamp
            let object = [];

            let timestamp = 0.0;
            for (i = 0;i < results.length;++i) {
                //keep tabs on the timestamp
                if (results[i]["timestamp"] != timestamp) {
                    objects[timestamp] = object;
                    timestamp = results[i]["timestamp"];
                    object = [];
                }

                //keep tabs on the classes pool (no repetition)
                let found = false;
                for (j = 0;j < classes.length;++j) {
                    if (results[i]["class"] == classes[j]["index"]) {
                        found = true;
                        break;
                    } 
                }
                if (!found) {
                    classes.push({"index": results[i]["class"], "label": results[i]["name"]});
                }

                //save bounding box, timestamp and class number
                object.push({
                    "min_x": results[i]["xmin"], 
                    "min_y": results[i]["ymin"], 
                    "max_x": results[i]["xmax"], 
                    "max_y": results[i]["ymax"],
                    "label": results[i]["class"],
                    "timestamp": results[i]["timestamp"]
                });
            }

            window.objs = {"results": objects, "classes": classes, "maxTime": body["frames"]};
            console.log(window.objs);

            //show button for toggling obj chart
            toggle_obj.style.display = "block";
            //obj_plot.addEventListener("click", (event) => update_frame_index_onclick(obj_plot, score_plotOffsetLeft, score_plotOffsetRight, score_plotOffsetY, window.max_index, event));

            update_scores(window.current_index);
        }
        catch (error) {
            console.error("Error detecting objects: ", error);
        }
    });

    depthEstimate.addEventListener("click", async () => {
        try {
            //compute the depth map
            const response = await fetch(`${server_url}/video/depth/${window.current_video}`);
            const body = await response.json();
            console.log(body);

            //display the depth map of the current frame only
            update_depth_video(window.current_index);

            toggle_depth.style.display = "block";
            window.depth = true;
        }
        catch (error) {
            console.error("Error computing depth map: ", error);
        }
    });

</script>
<script src="video_selection.js"></script>
<script src="similarity_scores_plot.js"></script>
<script src="crop_script.js"></script>
<script src="tsne_plot.js"></script>
<script src="obj_detec_plot.js"></script>
<script src="depth_script.js"></script>
<script src="timeline.js"></script>

</body>
</html>
